{% extends "base.html" %}

{% block title %}Exam Results - ExamPortal{% endblock %}

{% block content %}
<div class="container mt-5">

    {% if from_history %}
    <div class="row mb-3">
        <div class="col text-center">
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm"
               style="border:1px solid #fff; color:#fff;">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="result-card text-center">
                <!-- Success Icon and Title -->
                <div class="mb-4">
                    <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                    <h2 class="text-primary">Exam Completed Successfully!</h2>
                </div>

                <!-- Exam Information -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-file-alt"></i> {{ exam.name }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Date:</strong> {{ exam.date }}</p>
                                <p><strong>Duration:</strong> {{ exam.duration }} minutes</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Submitted At:</strong> {{ result.completed_at }}</p>
                                <p><strong>Time Taken:</strong> {{ result.time_taken_minutes }} minutes</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">Completed</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Score Display -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h3 class="text-primary">{{ result.score }}</h3>
                                <p class="text-muted mb-0">Score Obtained</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body">
                                <h3 class="text-info">{{ result.max_score }}</h3>
                                <p class="text-muted mb-0">Maximum Score</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h3 class="text-warning">{{ result.total_questions }}</h3>
                                <p class="text-muted mb-0">Total Questions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h3 class="text-success">{{ result.percentage }}%</h3>
                                <p class="text-muted mb-0">Percentage</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grade Display -->
                <div class="mb-4">
                    <h3>Your Grade:
                        <span class="badge
                            {% if result.grade == 'A+' or result.grade == 'A' %}bg-success
                            {% elif result.grade == 'B' %}bg-primary
                            {% elif result.grade == 'C' %}bg-warning
                            {% else %}bg-danger{% endif %} fs-4">
                            {{ result.grade }}
                        </span>
                    </h3>
                </div>

                <!-- Performance Analysis with Fixed Metrics -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Performance Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-success">
                                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                                    <h4>{{ result.correct_answers if result.correct_answers is defined else 0 }}</h4>
                                    <p class="mb-0">Correct</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-danger">
                                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                                    <h4>{{ result.incorrect_answers if result.incorrect_answers is defined else 0 }}</h4>
                                    <p class="mb-0">Incorrect</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted">
                                    <i class="fas fa-question-circle fa-2x mb-2"></i>
                                    <h4>{{ result.unanswered_questions if result.unanswered_questions is defined else 0 }}</h4>
                                    <p class="mb-0">Unanswered</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-warning">
                                    <i class="fas fa-star fa-2x mb-2"></i>
                                    <h4>{{ result.grade }}</h4>
                                    <p class="mb-0">Grade</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Detailed Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <strong>Attempted:</strong> {{ (result.correct_answers if result.correct_answers is defined else 0) + (result.incorrect_answers if result.incorrect_answers is defined else 0) }} / {{ result.total_questions }}
                            </div>
                            <div class="col-md-4">
                                <strong>Accuracy:</strong>
                                {% set attempted = (result.correct_answers if result.correct_answers is defined else 0) + (result.incorrect_answers if result.incorrect_answers is defined else 0) %}
                                {% if attempted > 0 %}
                                    {{ ((result.correct_answers if result.correct_answers is defined else 0) / attempted * 100) | round(1) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <strong>Overall Score:</strong> {{ result.percentage }}%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Message -->
                <div class="alert
                    {% if result.percentage >= 80 %}alert-success
                    {% elif result.percentage >= 60 %}alert-info
                    {% elif result.percentage >= 40 %}alert-warning
                    {% else %}alert-danger{% endif %} mb-4">
                    {% if result.percentage >= 80 %}
                        <i class="fas fa-trophy"></i> <strong>Excellent Performance!</strong>
                        You have demonstrated a strong understanding of the subject matter.
                    {% elif result.percentage >= 60 %}
                        <i class="fas fa-thumbs-up"></i> <strong>Good Job!</strong>
                        You have a solid grasp of the concepts. Keep up the good work!
                    {% elif result.percentage >= 40 %}
                        <i class="fas fa-info-circle"></i> <strong>Fair Performance.</strong>
                        There's room for improvement. Consider reviewing the topics you missed.
                    {% else %}
                        <i class="fas fa-exclamation-triangle"></i> <strong>Needs Improvement.</strong>
                        We recommend studying the material more thoroughly and seeking additional help if needed.
                    {% endif %}
                </div>

                <!-- Enhanced Loading Alert for Response Analysis -->
                <div class="alert alert-primary" id="responseLoadingAlert" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-3 text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong id="responseLoadingTitle">Preparing Response Analysis...</strong>
                                    <div class="small" id="responseLoadingSubtitle">Loading your detailed answers and solutions</div>
                                </div>
                                <div id="responseLoadingPercentage" class="fw-bold text-primary">0%</div>
                            </div>
                            <div class="progress mt-2" style="height: 8px; border-radius: 4px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                     role="progressbar" style="width: 0%; transition: width 0.3s ease;" id="responseProgress"></div>
                            </div>
                            <div class="small mt-2 text-muted" id="responseLoadingDetails">
                                Fetching response data...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button class="btn btn-success btn-lg me-md-2" id="viewResponseBtn" onclick="openResponseAnalysisWithLoading()">
                        <i class="fas fa-clipboard-check"></i> View Detailed Response
                    </button>

                    <button class="btn btn-primary btn-lg me-md-2" onclick="closeExamWindow()">
                        <i class="fas fa-times"></i> Close Exam
                    </button>

                    <button class="btn btn-outline-secondary btn-lg" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Result
                    </button>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Click "View Detailed Response" to see your answers, correct solutions, and download a detailed report.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function closeExamWindow() {
    window.close();
}

function openResponseAnalysisWithLoading() {
    const loadingAlert = document.getElementById('responseLoadingAlert');
    const viewResponseBtn = document.getElementById('viewResponseBtn');
    const progressBar = document.getElementById('responseProgress');
    const loadingTitle = document.getElementById('responseLoadingTitle');
    const loadingSubtitle = document.getElementById('responseLoadingSubtitle');
    const loadingDetails = document.getElementById('responseLoadingDetails');
    const loadingPercentage = document.getElementById('responseLoadingPercentage');

    // Show loading and disable button
    loadingAlert.style.display = 'block';
    viewResponseBtn.disabled = true;
    viewResponseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

    // Scroll to loading alert
    loadingAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Professional loading sequence for response analysis
    const loadingSteps = [
        { progress: 15, title: "Fetching Your Responses...", subtitle: "Retrieving your submitted answers", details: "Loading your exam responses from database" },
        { progress: 35, title: "Loading Question Details...", subtitle: "Gathering question information", details: "Fetching question text and options" },
        { progress: 55, title: "Processing Answer Analysis...", subtitle: "Comparing your answers", details: "Analyzing correct vs incorrect responses" },
        { progress: 75, title: "Loading Question Images...", subtitle: "Preparing visual content", details: "Optimizing diagrams and images for display" },
        { progress: 90, title: "Generating Performance Report...", subtitle: "Creating detailed analysis", details: "Calculating performance metrics and insights" },
        { progress: 100, title: "Opening Response Analysis...", subtitle: "Analysis ready!", details: "Launching detailed response viewer" }
    ];

    let currentStep = 0;

    function updateLoadingProgress() {
        if (currentStep < loadingSteps.length) {
            const step = loadingSteps[currentStep];

            // Update progress bar and text
            progressBar.style.width = step.progress + '%';
            loadingPercentage.textContent = step.progress + '%';
            loadingTitle.textContent = step.title;
            loadingSubtitle.textContent = step.subtitle;
            loadingDetails.textContent = step.details;

            currentStep++;

            if (step.progress < 100) {
                // Continue to next step after delay
                setTimeout(updateLoadingProgress, Math.random() * 600 + 300); // 300-900ms random delay
            } else {
                // Loading complete - open the response page
                setTimeout(openActualResponsePage, 500);
            }
        }
    }

    function openActualResponsePage() {
        // Hide loading alert
        loadingAlert.style.display = 'none';

        // Reset button
        viewResponseBtn.disabled = false;
        viewResponseBtn.innerHTML = '<i class="fas fa-clipboard-check"></i> View Detailed Response';

        // Open response analysis in a new window
        let width = screen.availWidth * 0.9;
        let height = screen.availHeight * 0.9;
        let left = (screen.availWidth - width) / 2;
        let top = (screen.availHeight - height) / 2;

        let features = `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes,menubar=no,toolbar=no,location=no,status=no`;

        let responseWindow = window.open('{{ url_for("response_page", exam_id=exam.id) }}', '_blank', features);
        if (responseWindow) {
            responseWindow.focus();
        } else {
            alert('Please allow popups for this site to view detailed response.');
            // Fallback - redirect in same window
            window.location.href = '{{ url_for("response_page", exam_id=exam.id) }}';
        }
    }

    function showLoadingError(message) {
        loadingAlert.style.display = 'none';
        viewResponseBtn.disabled = false;
        viewResponseBtn.innerHTML = '<i class="fas fa-clipboard-check"></i> View Detailed Response';
        alert('Error loading response analysis: ' + message + '\n\nTrying direct access...');
        // Fallback to direct access
        openActualResponsePage();
    }

    // Start the loading sequence
    updateLoadingProgress();
}

// Alternative function for simple opening (fallback)
function openResponseAnalysis() {
    let width = screen.availWidth * 0.9;
    let height = screen.availHeight * 0.9;
    let left = (screen.availWidth - width) / 2;
    let top = (screen.availHeight - height) / 2;

    let features = `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes,menubar=no,toolbar=no,location=no,status=no`;

    let responseWindow = window.open('{{ url_for("response_page", exam_id=exam.id) }}', '_blank', features);
    if (responseWindow) {
        responseWindow.focus();
    } else {
        alert('Please allow popups for this site to view detailed response.');
    }
}
</script>

<style>
@media print {
    .navbar, .btn, #responseLoadingAlert { display: none !important; }
    body { background: white !important; }
    .result-card { box-shadow: none !important; }
}

/* Loading animation styles */
#responseLoadingAlert {
    border-left: 5px solid #0d6efd;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
}

#responseProgress {
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(13, 110, 253, 0.3);
}

.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}
</style>
{% endblock %}